<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–î–µ—Ç–µ–∫—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .img-container {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .img-container img:hover {
            transform: scale(1.02);
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .upload-group {
            margin-bottom: 1rem;
        }
        .result-row {
            min-height: 400px;
        }
        .summary-table tbody tr.status-ok {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
            font-weight: 600;
        }
        .summary-table tbody tr.status-error {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: 600;
        }
        .summary-table tbody tr.status-ok td,
        .summary-table tbody tr.status-error td {
            background-color: inherit !important;
            color: inherit !important;
        }
        .verification-table .status-verified {
            background-color: #e8f5e9 !important;
        }
        .verification-table .status-error {
            background-color: #ffebee !important;
        }
        .verification-table .status-missing {
            background-color: #fff3e0 !important;
        }
        .progress {
            height: 20px;
            margin-top: 5px;
        }
        .btn-verify {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            font-weight: bold;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û */
        .modal-fullscreen-img {
            --bs-modal-width: 100vw;
            --bs-modal-margin: 0px;
        }
        .modal-fullscreen-img .modal-dialog {
            max-width: none;
            width: 100vw;
            height: 100vh;
            margin: 0;
        }
        .modal-fullscreen-img .modal-content {
            background: rgba(0,0,0,0.95);
            border: none;
            border-radius: 0;
            height: 100vh;
            position: relative;
            cursor: pointer; /* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω */
        }
        .modal-fullscreen-img .modal-header {
            border-bottom: none;
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1060;
            padding: 1rem;
        }
        .modal-fullscreen-img .modal-body {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            height: 100vh;
            width: 100vw;
            cursor: default;
        }
        .modal-fullscreen-img img {
            max-width: 95vw;
            max-height: 95vh;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: zoom-in;
            transition: transform 0.3s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
        .modal-fullscreen-img .btn-close {
            background: #fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
            opacity: 1;
            padding: 1rem;
            background-size: 1.5em;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1070;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .modal-fullscreen-img .btn-close:hover {
            opacity: 1;
            background-color: #fff;
            border-color: #fff;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.7);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-waiting { background-color: #6c757d; }
        .status-processing { background-color: #ffc107; }
        .status-ready { background-color: #28a745; }
        .status-error { background-color: #dc3545; }

        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .image-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .img-container:hover .image-actions {
            opacity: 1;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
        .fullscreen-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 10px;
            z-index: 1050;
        }
        .fullscreen-controls .btn {
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .fullscreen-controls .btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä –≤ —Ç–∞–±–ª–∏—Ü–µ */
        .table-image-thumb {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid #dee2e6;
        }
        .table-image-thumb:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }
        .image-cell {
            text-align: center;
            vertical-align: middle;
        }
        .image-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 2px;
        }

        /* –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
        .btn-simple {
            min-width: 120px;
            height: 38px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
        .verification-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .verification-processing {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .verification-success {
            background-color: #d1edff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }
        .verification-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-3">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#single">–û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#batch">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/verify-page">üîç –†–µ–∂–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</a>
        </li>
    </ul>
    <div class="tab-content">

        <!-- –í–∫–ª–∞–¥–∫–∞: –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
        <div class="tab-pane fade show active" id="single">
            <div class="row mb-4 justify-content-center">
                <div class="col-md-4">
                    <label for="user_id" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="user_id" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ ID">
                </div>
            </div>

            <input type="hidden" id="session_id" value="{{ session_id }}">

            <div class="row result-row g-4 mb-4">
                <div class="col-md-6">
                    <div class="section-title">
                        <span class="status-indicator status-waiting" id="taken_status"></span>
                        üì∏ –í–∑—è—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                    </div>
                    <div class="upload-group">
                        <input type="file" id="taken_file" class="form-control" accept="image/*">
                    </div>
                    <button class="btn btn-primary btn-simple" onclick="processImage('taken')" id="taken_btn">
                        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
                    </button>
                    <div class="img-container mt-3" id="taken_container">
                        <div id="taken_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                        <div class="image-actions">
                            <button class="btn btn-light btn-sm" onclick="openFullscreen('taken')" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                                üîç
                            </button>
                        </div>
                    </div>
                    <div id="taken_info" class="mt-2 small text-muted"></div>
                </div>

                <div class="col-md-6">
                    <div class="section-title">
                        <span class="status-indicator status-waiting" id="returned_status"></span>
                        üì§ –°–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                    </div>
                    <div class="upload-group">
                        <input type="file" id="returned_file" class="form-control" accept="image/*">
                    </div>
                    <button class="btn btn-success btn-simple" onclick="processImage('returned')" id="returned_btn">
                        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
                    </button>
                    <div class="img-container mt-3" id="returned_container">
                        <div id="returned_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                        <div class="image-actions">
                            <button class="btn btn-light btn-sm" onclick="openFullscreen('returned')" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                                üîç
                            </button>
                        </div>
                    </div>
                    <div id="returned_info" class="mt-2 small text-muted"></div>
                </div>
            </div>

            <div class="text-center mb-4">
                <button class="btn btn-info me-2" onclick="compare()">üìä –°—Ä–∞–≤–Ω–∏—Ç—å</button>
                <button class="btn btn-verify btn-with-spinner" onclick="verifyObjects()" id="verify_btn">
                    <span class="btn-text">üîç –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã</span>
                    <span class="spinner-border spinner-border-sm d-none btn-spinner" id="verify_spinner"></span>
                </button>
            </div>

            <div id="verification_status"></div>
            <div id="comparison_result"></div>
            <div id="verification_result"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ -->
        <div class="tab-pane fade" id="batch">
            <h4 class="mb-3">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h4>

            <div class="mb-3">
                <input type="file" id="batch_files" class="form-control" multiple accept="image/*">
            </div>

            <button class="btn btn-primary mb-3" onclick="batchProcess()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

            <div id="batch_progress_container"></div>
            <div id="batch_result"></div>
        </div>

    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø -->
<div class="modal fade" id="fullscreenModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-fullscreen-img">
        <div class="modal-content" onclick="closeFullscreenModal(event)">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="event.stopPropagation()"></button>
            </div>
            <div class="modal-body" onclick="event.stopPropagation()">
                <img id="fullscreenImage" src="" alt="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                     onclick="zoomImage(event)" ondblclick="resetZoom()">
            </div>
            <div class="fullscreen-controls" onclick="event.stopPropagation()">
                <button class="btn btn-sm" onclick="zoomIn()">+ –£–≤–µ–ª–∏—á–∏—Ç—å</button>
                <button class="btn btn-sm" onclick="zoomOut()">- –£–º–µ–Ω—å—à–∏—Ç—å</button>
                <button class="btn btn-sm" onclick="resetZoom()">‚ü≥ –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const sessionId = "{{ session_id }}";
    let currentImages = {
        taken: null,
        returned: null
    };
    let currentZoom = 1;
    let tempImagesCache = {}; // –ö—ç—à –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏ temp
    let fullscreenModal = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        fullscreenModal = new bootstrap.Modal(document.getElementById('fullscreenModal'));

        updateStatus('taken', 'waiting', '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞...');
        updateStatus('returned', 'waiting', '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞...');
    });

    // === –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ===
    document.getElementById('taken_file')?.addEventListener('change', function(e) {
        previewImage(e, 'taken');
    });
    document.getElementById('returned_file')?.addEventListener('change', function(e) {
        previewImage(e, 'returned');
    });

    function updateStatus(kind, status, message = '') {
        const statusElement = document.getElementById(kind + '_status');
        const infoElement = document.getElementById(kind + '_info');

        statusElement.className = 'status-indicator';
        statusElement.classList.add(`status-${status}`);

        if (message) {
            infoElement.innerHTML = message;
        }
    }

    function showProcessingOverlay(kind, show) {
        const container = document.getElementById(kind + '_container');
        const btn = document.getElementById(kind + '_btn');

        if (show) {
            // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            let overlay = container.querySelector('.processing-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'processing-overlay';
                overlay.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
                    </div>
                    <div class="mt-2">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
                `;
                container.appendChild(overlay);
            }
            overlay.style.display = 'flex';

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            btn.disabled = true;
        } else {
            // –£–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
            const overlay = container.querySelector('.processing-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            btn.disabled = false;
        }
    }

    function previewImage(event, kind) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            currentImages[kind] = e.target.result;
            document.getElementById(kind + '_preview').innerHTML =
                `<img src="${e.target.result}" alt="preview" onclick="openFullscreen('${kind}')">`;
            updateStatus(kind, 'waiting', '‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å" –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.');
        };
        reader.readAsDataURL(file);
    }

    async function processImage(kind) {
        const input = document.getElementById(kind + '_file');
        const file = input.files[0];
        if (!file) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        updateStatus(kind, 'processing', '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        showProcessingOverlay(kind, true);

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(`/detect/${kind}/${sessionId}`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);
            }

            const data = await res.json();

            if (data.image_url) {
                currentImages[kind] = data.image_url;
                document.getElementById(kind + '_preview').innerHTML =
                    `<img src="${data.image_url}" alt="result" onclick="openFullscreen('${kind}')">`;

                const detectionCount = data.detections ? data.detections.length : 0;
                updateStatus(kind, 'ready', `‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–π–¥–µ–Ω–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${detectionCount}`);
            }
        } catch (error) {
            console.error('Error:', error);
            updateStatus(kind, 'error', `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${error.message}`);
        } finally {
            showProcessingOverlay(kind, false);
        }
    }

    function openFullscreen(kind) {
        if (!currentImages[kind]) {
            alert('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
            return;
        }

        const fullscreenImage = document.getElementById('fullscreenImage');
        fullscreenImage.src = currentImages[kind];
        currentZoom = 1;
        fullscreenImage.style.transform = `scale(${currentZoom})`;

        fullscreenModal.show();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    function closeFullscreenModal(event) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ñ–æ–Ω (—Å–∞–º modal-content), –∞ –Ω–µ –Ω–∞ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        if (event.target === event.currentTarget) {
            fullscreenModal.hide();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ temp
    function openTempImage(imagePath, title = '') {
        const fullscreenImage = document.getElementById('fullscreenImage');

        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ø–æ –ø—Ä—è–º–æ–º—É URL
        if (tempImagesCache[imagePath]) {
            fullscreenImage.src = tempImagesCache[imagePath];
        } else {
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–∞–ø–∫–∏ temp
            const tempUrl = `/static/verification/${imagePath}`;
            fullscreenImage.src = tempUrl;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            fullscreenImage.onload = function() {
                tempImagesCache[imagePath] = tempUrl;
            };

            fullscreenImage.onerror = function() {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + imagePath);
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', imagePath);
            };
        }

        currentZoom = 1;
        fullscreenImage.style.transform = `scale(${currentZoom})`;

        fullscreenModal.show();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º
    function zoomIn() {
        currentZoom = Math.min(currentZoom + 0.2, 3);
        document.getElementById('fullscreenImage').style.transform = `scale(${currentZoom})`;
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom - 0.2, 0.5);
        document.getElementById('fullscreenImage').style.transform = `scale(${currentZoom})`;
    }

    function resetZoom() {
        currentZoom = 1;
        document.getElementById('fullscreenImage').style.transform = `scale(${currentZoom})`;
    }

    // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    function zoomImage(event) {
        event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
        if (currentZoom < 2) {
            currentZoom += 0.5;
        } else {
            currentZoom = 1;
        }
        document.getElementById('fullscreenImage').style.transform = `scale(${currentZoom})`;
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (fullscreenModal) {
                fullscreenModal.hide();
            }
        }
    });

    async function compare() {
        const res = await fetch(`/compare/${sessionId}`);
        const data = await res.json();

        if (data.error) { alert(data.error); return; }

        let table = `<h4 class="mb-3">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h4>
        <div class="table-responsive">
        <table class="table table-bordered summary-table">
            <thead class="table-light">
                <tr>
                    <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                    <th>–í–∑—è—Ç–æ</th>
                    <th>–°–¥–∞–Ω–æ</th>
                    <th>–ò—Ç–æ–≥</th>
                </tr>
            </thead>
            <tbody>`;

        data.summary.forEach(row => {
            const diff = row.returned - row.taken;
            const rowClass = (diff === 0) ? 'status-ok' : 'status-error';
            table += `<tr class="${rowClass}">
                <td>${row.tool}</td>
                <td>${row.taken}</td>
                <td>${row.returned}</td>
                <td>${diff}</td>
            </tr>`;
        });

        table += `</tbody></table></div>`;
        document.getElementById('comparison_result').innerHTML = table;
    }

    async function verifyObjects() {
        const verifyBtn = document.getElementById('verify_btn');
        const verifySpinner = document.getElementById('verify_spinner');
        const statusContainer = document.getElementById('verification_status');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
        statusContainer.innerHTML = `
            <div class="verification-status verification-processing">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                ‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤...
            </div>
        `;

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        verifyBtn.disabled = true;
        verifySpinner.classList.remove('d-none');

        try {
            const res = await fetch(`/verify/${sessionId}`, {
                method: 'POST'
            });

            if (!res.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            }

            const data = await res.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            statusContainer.innerHTML = `
                <div class="verification-status verification-success">
                    ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                </div>
            `;

            displayVerificationResults(data.verification_results);

        } catch (error) {
            console.error('Error:', error);
            statusContainer.innerHTML = `
                <div class="verification-status verification-error">
                    ‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}
                </div>
            `;
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            verifyBtn.disabled = false;
            verifySpinner.classList.add('d-none');
        }
    }

    function displayVerificationResults(results) {
        let table = `<h4 class="mb-3 mt-4">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤</h4>
        <div class="table-responsive">
        <table class="table table-bordered verification-table">
            <thead class="table-light">
                <tr>
                    <th>Class ID</th>
                    <th>–ò–º—è –∫–ª–∞—Å—Å–∞</th>
                    <th>–í–∑—è—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                    <th>–°–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                    <th>–°—Ö–æ–¥—Å—Ç–≤–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ—Ç–∞–ª–∏</th>
                </tr>
            </thead>
            <tbody>`;

        for (const [classId, result] of Object.entries(results)) {
            let statusClass = '';
            let statusText = '';
            let details = '';

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ temp
            const takenImagePath = `taken_crop_${classId}.jpg`;
            const returnedImagePath = `returned_crop_${classId}.jpg`;

            if (result.status === 'verified') {
                statusClass = result.is_same ? 'status-verified' : '';
                statusText = result.is_same ? '‚úÖ –°–æ–≤–ø–∞–¥–∞–µ—Ç' : '‚ùå –ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç';
                details = `–°—Ö–æ–¥—Å—Ç–≤–æ: ${result.similarity.toFixed(3)}`;
            } else if (result.status === 'class_missing') {
                statusClass = 'status-missing';
                statusText = '‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                details = result.message;
            } else if (result.status === 'extra_class') {
                statusClass = 'status-missing';
                statusText = '‚ö† –õ–∏—à–Ω–∏–π';
                details = result.message;
            } else if (result.status === 'error') {
                statusClass = 'status-error';
                statusText = '‚ùå –û—à–∏–±–∫–∞';
                details = result.message;
            }

            table += `<tr class="${statusClass}">
                <td><strong>${classId}</strong></td>
                <td><strong>${result.class_name}</strong></td>
                <td class="image-cell">
                    ${result.status === 'verified' || result.status === 'class_missing' ?
                        `<img src="/static/verification/${takenImagePath}"
                              alt="–í–∑—è—Ç—ã–π ${classId}"
                              class="table-image-thumb"
                              onclick="openTempImage('${takenImagePath}', '–í–∑—è—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç - ${result.class_name}')"
                              onerror="this.style.display='none'">
                         <div class="image-label">–í–∑—è—Ç—ã–π</div>` :
                        'N/A'}
                </td>
                <td class="image-cell">
                    ${result.status === 'verified' || result.status === 'extra_class' ?
                        `<img src="/static/verification/${returnedImagePath}"
                              alt="–°–¥–∞–Ω–Ω—ã–π ${classId}"
                              class="table-image-thumb"
                              onclick="openTempImage('${returnedImagePath}', '–°–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç - ${result.class_name}')"
                              onerror="this.style.display='none'">
                         <div class="image-label">–°–¥–∞–Ω–Ω—ã–π</div>` :
                        'N/A'}
                </td>
                <td>${result.similarity ? result.similarity.toFixed(3) : 'N/A'}</td>
                <td>${statusText}</td>
                <td><small>${details}</small></td>
            </tr>`;
        }

        table += `</tbody></table></div>`;
        document.getElementById('verification_result').innerHTML = table;

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫—ç—à–∞
        preloadTempImages(results);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ temp
    function preloadTempImages(results) {
        for (const [classId, result] of Object.entries(results)) {
            if (result.status === 'verified' || result.status === 'class_missing') {
                const takenImage = new Image();
                takenImage.src = `/static/verification/taken_crop_${classId}.jpg`;
                takenImage.onload = function() {
                    tempImagesCache[`taken_crop_${classId}.jpg`] = this.src;
                };
            }
            if (result.status === 'verified' || result.status === 'extra_class') {
                const returnedImage = new Image();
                returnedImage.src = `/static/verification/returned_crop_${classId}.jpg`;
                returnedImage.onload = function() {
                    tempImagesCache[`returned_crop_${classId}.jpg`] = this.src;
                };
            }
        }
    }

    // === –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º ===
    let batchResultBlob = null;

    async function batchProcess() {
        const fileInput = document.getElementById('batch_files');
        const files = fileInput.files;
        if (files.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        const progressContainer = document.getElementById('batch_progress_container');
        const resultContainer = document.getElementById('batch_result');
        resultContainer.innerHTML = '';
        progressContainer.innerHTML = `
            <div class="alert alert-info">–û–±—Ä–∞–±–æ—Ç–∫–∞ ${files.length} —Ñ–∞–π–ª–æ–≤...</div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 100%"></div>
            </div>
        `;

        try {
            const res = await fetch('/api/batch-detect', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

            const jsonText = await res.text();
            batchResultBlob = new Blob([jsonText], { type: 'application/json' });

            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
            resultContainer.innerHTML = `
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <span>‚úÖ –§–∞–π–ª JSON —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω</span>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadBatchResult('${timestamp}')">
                        –°–∫–∞—á–∞—Ç—å JSON-—Ñ–∞–π–ª
                    </button>
                </div>
            `;

        } catch (error) {
            console.error(error);
            resultContainer.innerHTML =
                `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        } finally {
            progressContainer.innerHTML = '';
        }
    }

    function downloadBatchResult(timestamp) {
        if (!batchResultBlob) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
            return;
        }
        const url = URL.createObjectURL(batchResultBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `batch_result_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>