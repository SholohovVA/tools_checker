<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–î–µ—Ç–µ–∫—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .img-container {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .upload-group {
            margin-bottom: 1rem;
        }
        .result-row {
            min-height: 400px;
        }
        .summary-table tbody tr.status-ok {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
            font-weight: 600;
        }
        .summary-table tbody tr.status-error {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: 600;
        }
        .summary-table tbody tr.status-ok td,
        .summary-table tbody tr.status-error td {
            background-color: inherit !important;
            color: inherit !important;
        }
        .progress {
            height: 20px;
            margin-top: 5px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-3">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#single">–û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#batch">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</a>
        </li>
    </ul>

    <div class="tab-content">

        <!-- –í–∫–ª–∞–¥–∫–∞: –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
        <div class="tab-pane fade show active" id="single">
            <div class="row mb-4 justify-content-center">
                <div class="col-md-4">
                    <label for="user_id" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="user_id" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ ID">
                </div>
            </div>

            <input type="hidden" id="session_id" value="{{ session_id }}">

            <div class="row result-row g-4 mb-4">
                <div class="col-md-6">
                    <div class="section-title">üì∏ –í–∑—è—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
                    <div class="upload-group">
                        <input type="file" id="taken_file" class="form-control" accept="image/*">
                    </div>
                    <button class="btn btn-primary" onclick="processImage('taken')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                    <div class="img-container mt-3">
                        <div id="taken_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="section-title">üì§ –°–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
                    <div class="upload-group">
                        <input type="file" id="returned_file" class="form-control" accept="image/*">
                    </div>
                    <button class="btn btn-success" onclick="processImage('returned')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                    <div class="img-container mt-3">
                        <div id="returned_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                    </div>
                </div>
            </div>

            <div class="text-center mb-4">
                <button class="btn btn-info" onclick="compare()">üìä –°—Ä–∞–≤–Ω–∏—Ç—å</button>
            </div>

            <div id="comparison_result"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ -->
        <div class="tab-pane fade" id="batch">
            <h4 class="mb-3">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h4>

            <div class="mb-3">
                <input type="file" id="batch_files" class="form-control" multiple accept="image/*">
            </div>

            <button class="btn btn-primary mb-3" onclick="batchProcess()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

            <div id="batch_progress_container"></div>
            <div id="batch_result"></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const sessionId = "{{ session_id }}";

    // === –û–¥–∏–Ω–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ===
    document.getElementById('taken_file')?.addEventListener('change', function(e) {
        previewImage(e, 'taken_preview');
    });
    document.getElementById('returned_file')?.addEventListener('change', function(e) {
        previewImage(e, 'returned_preview');
    });

    function previewImage(event, targetId) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(targetId).innerHTML = `<img src="${e.target.result}" alt="preview">`;
        };
        reader.readAsDataURL(file);
    }

    async function processImage(kind) {
        const input = document.getElementById(kind + '_file');
        const file = input.files[0];
        if (!file) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!'); return; }

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`/detect/${kind}/${sessionId}`, {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.image_url) {
            document.getElementById(kind + '_preview').innerHTML =
                `<img src="${data.image_url}" alt="result">`;
        }
    }

    async function compare() {
        const res = await fetch(`/compare/${sessionId}`);
        const data = await res.json();

        if (data.error) { alert(data.error); return; }

        let table = `<h4 class="mb-3">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h4>
        <div class="table-responsive">
        <table class="table table-bordered summary-table">
            <thead class="table-light">
                <tr>
                    <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                    <th>–í–∑—è—Ç–æ</th>
                    <th>–°–¥–∞–Ω–æ</th>
                    <th>–ò—Ç–æ–≥</th>
                </tr>
            </thead>
            <tbody>`;

        data.summary.forEach(row => {
            const diff = row.returned - row.taken;
            const rowClass = (diff === 0) ? 'status-ok' : 'status-error';
            table += `<tr class="${rowClass}">
                <td>${row.tool}</td>
                <td>${row.taken}</td>
                <td>${row.returned}</td>
                <td>${diff}</td>
            </tr>`;
        });

        table += `</tbody></table></div>`;
        document.getElementById('comparison_result').innerHTML = table;
    }

    // === –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º ===
    let batchResultBlob = null;  // —Ö—Ä–∞–Ω–∏–º blob –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

    async function batchProcess() {
        const fileInput = document.getElementById('batch_files');
        const files = fileInput.files;
        if (files.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        const progressContainer = document.getElementById('batch_progress_container');
        const resultContainer = document.getElementById('batch_result');
        resultContainer.innerHTML = '';
        progressContainer.innerHTML = `
            <div class="alert alert-info">–û–±—Ä–∞–±–æ—Ç–∫–∞ ${files.length} —Ñ–∞–π–ª–æ–≤...</div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 100%"></div>
            </div>
        `;

        try {
            const res = await fetch('/api/batch-detect', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

            // –ü–æ–ª—É—á–∞–µ–º JSON –∫–∞–∫ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const jsonText = await res.text();
            batchResultBlob = new Blob([jsonText], { type: 'application/json' });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
            resultContainer.innerHTML = `
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <span>‚úÖ –§–∞–π–ª JSON —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω</span>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadBatchResult('${timestamp}')">
                        –°–∫–∞—á–∞—Ç—å JSON-—Ñ–∞–π–ª
                    </button>
                </div>
            `;

        } catch (error) {
            console.error(error);
            resultContainer.innerHTML =
                `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        } finally {
            progressContainer.innerHTML = '';
        }
    }

    function downloadBatchResult(timestamp) {
        if (!batchResultBlob) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
            return;
        }
        const url = URL.createObjectURL(batchResultBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `batch_result_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>