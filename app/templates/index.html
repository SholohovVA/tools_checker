<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–î–µ—Ç–µ–∫—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .img-container {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .upload-group {
            margin-bottom: 1rem;
        }
        .result-row {
            min-height: 400px;
        }

        /* üî¥üü¢ –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã ‚Äî —Å !important –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ */
        .summary-table tbody tr.status-ok {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
            font-weight: 600;
        }
        .summary-table tbody tr.status-error {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: 600;
        }

        /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —è—á–µ–π–∫–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç —Ü–≤–µ—Ç */
        .summary-table tbody tr.status-ok td,
        .summary-table tbody tr.status-error td {
            background-color: inherit !important;
            color: inherit !important;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <!-- –ü–æ–ª–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-4">
            <label for="user_id" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="user_id" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ ID">
        </div>
    </div>

    <input type="hidden" id="session_id" value="{{ session_id }}">

    <!-- –ï–¥–∏–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: —Ñ–æ—Ç–æ –≤–∑—è—Ç–æ / —Ñ–æ—Ç–æ —Å–¥–∞–Ω–æ -->
    <div class="row result-row g-4 mb-4">
        <!-- –í–∑—è—Ç–æ -->
        <div class="col-md-6">
            <div class="section-title">üì∏ –í–∑—è—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
            <div class="upload-group">
                <input type="file" id="taken_file" class="form-control" accept="image/*">
            </div>
            <button class="btn btn-primary" onclick="processImage('taken')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <div class="img-container mt-3">
                <div id="taken_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
            </div>
        </div>

        <!-- –°–¥–∞–Ω–æ -->
        <div class="col-md-6">
            <div class="section-title">üì§ –°–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
            <div class="upload-group">
                <input type="file" id="returned_file" class="form-control" accept="image/*">
            </div>
            <button class="btn btn-success" onclick="processImage('returned')">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            <div class="img-container mt-3">
                <div id="returned_preview" class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ</div>
            </div>
        </div>
    </div>

    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
    <div class="text-center mb-4">
        <button class="btn btn-info" onclick="compare()">üìä –°—Ä–∞–≤–Ω–∏—Ç—å</button>
    </div>

    <div id="comparison_result"></div>
</div>

<script>
    const sessionId = document.getElementById('session_id').value;

    document.getElementById('taken_file').addEventListener('change', function(e) {
        previewImage(e, 'taken_preview');
    });
    document.getElementById('returned_file').addEventListener('change', function(e) {
        previewImage(e, 'returned_preview');
    });

    function previewImage(event, targetId) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(targetId).innerHTML = `<img src="${e.target.result}" alt="preview">`;
        };
        reader.readAsDataURL(file);
    }

    async function processImage(kind) {
        const input = document.getElementById(kind + '_file');
        const file = input.files[0];
        if (!file) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!'); return; }

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`/detect/${kind}/${sessionId}`, {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.image_url) {
            document.getElementById(kind + '_preview').innerHTML =
                `<img src="${data.image_url}" alt="result">`;
        }
    }

    async function compare() {
        const res = await fetch(`/compare/${sessionId}`);
        const data = await res.json();

        if (data.error) { alert(data.error); return; }

        let table = `<h4 class="mb-3">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h4>
        <div class="table-responsive">
        <table class="table table-bordered summary-table">
            <thead class="table-light">
                <tr>
                    <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                    <th>–í–∑—è—Ç–æ</th>
                    <th>–°–¥–∞–Ω–æ</th>
                    <th>–ò—Ç–æ–≥</th>
                </tr>
            </thead>
            <tbody>`;

        data.summary.forEach(row => {
            const diff = row.returned - row.taken;
            const rowClass = (diff === 0) ? 'status-ok' : 'status-error';

            table += `<tr class="${rowClass}">
                <td>${row.tool}</td>
                <td>${row.taken}</td>
                <td>${row.returned}</td>
                <td>${diff}</td>
            </tr>`;
        });

        table += `</tbody></table></div>`;
        document.getElementById('comparison_result').innerHTML = table;
    }
</script>
</body>
</html>